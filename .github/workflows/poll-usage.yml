name: Poll Claude Usage

on:
  schedule:
    # Run every 5 minutes
    - cron: '*/5 * * * *'
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write

jobs:
  poll:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: data
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Checkout polling script from main
        uses: actions/checkout@v4
        with:
          ref: main
          path: main-branch
          sparse-checkout: |
            poll-usage.py
          sparse-checkout-cone-mode: false

      - name: Run polling script
        env:
          CLAUDE_ACCESS_TOKEN: ${{ secrets.CLAUDE_ACCESS_TOKEN }}
          CLAUDE_REFRESH_TOKEN: ${{ secrets.CLAUDE_REFRESH_TOKEN }}
          CLAUDE_TOKEN_EXPIRES_AT: ${{ secrets.CLAUDE_TOKEN_EXPIRES_AT }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # Copy script to data directory
          cp main-branch/poll-usage.py .

          # Initialize files if they don't exist
          if [ ! -f usage-history.json ]; then
            echo "[]" > usage-history.json
          fi

          if [ ! -f state.json ]; then
            echo "{}" > state.json
          fi

          if [ ! -f config.json ]; then
            cat > config.json << 'EOF'
          {
            "thresholds": [50, 75, 90],
            "telegram_enabled": true
          }
          EOF
          fi

          # Run the poll
          python poll-usage.py

          # Clean up script (don't commit it to data branch)
          rm poll-usage.py
          rm -rf main-branch

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add usage-history.json state.json config.json

          # Only commit if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update usage data [skip ci]"
            git push
          fi
