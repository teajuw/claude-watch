#!/bin/bash
# fetch-credentials - Pull latest OAuth tokens from Worker before using Claude CLI
#
# This enables "Worker-first" token management where the Worker is the single
# source of truth for OAuth tokens. Run this before starting Claude to ensure
# you have the latest tokens that the Worker has refreshed.
#
# Usage:
#   fetch-credentials        # Fetch and write to ~/.claude/.credentials.json
#   fetch-credentials --check # Just check if Worker has newer tokens

set -e

CLAUDE_CREDS="$HOME/.claude/.credentials.json"
WORKER_URL="https://claude-watch.trevorju32.workers.dev"
CLAUDE_WATCH_DIR="${CLAUDE_WATCH_DIR:-$HOME/projects/claude-watch}"

# Load .env for API_SECRET
[ -f "$CLAUDE_WATCH_DIR/.env" ] && source "$CLAUDE_WATCH_DIR/.env"

if [ -z "$API_SECRET" ]; then
    echo "ERROR: API_SECRET not set in $CLAUDE_WATCH_DIR/.env"
    echo "This is required to securely fetch tokens from the Worker."
    exit 1
fi

# Fetch tokens from Worker
echo "Fetching tokens from Worker..."
RESPONSE=$(curl -s -w "\n%{http_code}" "$WORKER_URL/api/tokens" \
    -H "Authorization: Bearer $API_SECRET")

HTTP_CODE=$(echo "$RESPONSE" | tail -1)
BODY=$(echo "$RESPONSE" | sed '$d')

if [ "$HTTP_CODE" != "200" ]; then
    echo "ERROR: Failed to fetch tokens (HTTP $HTTP_CODE)"
    echo "$BODY"
    exit 1
fi

# Parse response
WORKER_ACCESS=$(echo "$BODY" | jq -r '.data.accessToken // empty')
WORKER_REFRESH=$(echo "$BODY" | jq -r '.data.refreshToken // empty')
WORKER_EXPIRES=$(echo "$BODY" | jq -r '.data.expiresAt // empty')

if [ -z "$WORKER_ACCESS" ] || [ -z "$WORKER_REFRESH" ]; then
    echo "ERROR: Worker returned empty tokens"
    echo "Make sure you've synced credentials to the Worker at least once."
    exit 1
fi

# Check-only mode
if [ "$1" = "--check" ]; then
    LOCAL_EXPIRES=$(jq -r '.claudeAiOauth.expiresAt // 0' "$CLAUDE_CREDS" 2>/dev/null || echo "0")

    echo "Worker token expires: $(date -d @$((WORKER_EXPIRES / 1000)) 2>/dev/null || echo "$WORKER_EXPIRES")"
    echo "Local token expires:  $(date -d @$((LOCAL_EXPIRES / 1000)) 2>/dev/null || echo "$LOCAL_EXPIRES")"

    if [ "$WORKER_EXPIRES" -gt "$LOCAL_EXPIRES" ]; then
        echo "✓ Worker has newer tokens"
        exit 0
    else
        echo "✓ Local tokens are current"
        exit 0
    fi
fi

# Backup existing credentials
if [ -f "$CLAUDE_CREDS" ]; then
    cp "$CLAUDE_CREDS" "$CLAUDE_CREDS.bak"
fi

# Update credentials file
# Read existing file and update only the OAuth portion
if [ -f "$CLAUDE_CREDS" ]; then
    # Merge new tokens into existing credentials
    jq --arg access "$WORKER_ACCESS" \
       --arg refresh "$WORKER_REFRESH" \
       --argjson expires "$WORKER_EXPIRES" \
       '.claudeAiOauth.accessToken = $access |
        .claudeAiOauth.refreshToken = $refresh |
        .claudeAiOauth.expiresAt = $expires' \
       "$CLAUDE_CREDS" > "$CLAUDE_CREDS.tmp" && mv "$CLAUDE_CREDS.tmp" "$CLAUDE_CREDS"
else
    # Create new credentials file
    echo "{
  \"claudeAiOauth\": {
    \"accessToken\": \"$WORKER_ACCESS\",
    \"refreshToken\": \"$WORKER_REFRESH\",
    \"expiresAt\": $WORKER_EXPIRES
  }
}" > "$CLAUDE_CREDS"
fi

echo "✓ Tokens updated from Worker"
echo "  Expires: $(date -d @$((WORKER_EXPIRES / 1000)) 2>/dev/null || echo "$WORKER_EXPIRES")"
