#!/bin/bash
# claude-sandbox - Spawn Claude in isolated Docker sandbox with monitoring hooks
# Replaces claude-agent start
set -e

# Config
CLAUDE_WATCH_DIR="${CLAUDE_WATCH_DIR:-$HOME/projects/claude-watch}"
CLAUDE_DATA_VOLUME="docker-claude-sandbox-data"
WORKER_URL="https://claude-watch.trevorju32.workers.dev"
CLAUDE_CREDS="$HOME/.claude/.credentials.json"

# Load .env for Telegram credentials
[ -f "$CLAUDE_WATCH_DIR/.env" ] && source "$CLAUDE_WATCH_DIR/.env"

# Agent ID - defaults to 'teajuw', override with -a/--agent flag or AGENT_ID env
AGENT_ID="${AGENT_ID:-teajuw}"

# =============================================================================
# Token Freshness Check
# =============================================================================
check_and_refresh_tokens() {
    # Check if credentials exist
    if [ ! -f "$CLAUDE_CREDS" ]; then
        echo "âš  No Claude credentials found. Run 'claude' to login first."
        return 1
    fi

    # Get expiry time
    local expires_at=$(jq -r '.claudeAiOauth.expiresAt // 0' "$CLAUDE_CREDS" 2>/dev/null)
    local now_ms=$(($(date +%s) * 1000))
    local buffer_ms=$((30 * 60 * 1000))  # 30 minute buffer

    if [ "$expires_at" -lt "$((now_ms + buffer_ms))" ]; then
        echo "ðŸ”„ Token expires soon, refreshing via local Claude..."
        # Run a quick claude command to trigger token refresh
        claude --version >/dev/null 2>&1 || true
        sleep 1
    fi

    # Check if we should sync to worker (if token was refreshed recently)
    local last_sync=$(cat "$CLAUDE_WATCH_DIR/.last-sync" 2>/dev/null || echo "0")
    local sync_interval=$((4 * 60 * 60))  # Sync every 4 hours
    local now=$(date +%s)

    if [ "$((now - last_sync))" -gt "$sync_interval" ]; then
        echo "â˜ Syncing credentials to Cloudflare Worker..."
        sync_to_worker_silent
        echo "$now" > "$CLAUDE_WATCH_DIR/.last-sync"
    fi
}

sync_to_worker_silent() {
    # Find wrangler
    local WRANGLER=""
    if command -v wrangler &> /dev/null; then
        WRANGLER="wrangler"
    elif [ -d "$HOME/.nvm" ]; then
        local NODE_DIR=$(ls "$HOME/.nvm/versions/node/" 2>/dev/null | head -1)
        if [ -n "$NODE_DIR" ]; then
            WRANGLER="$HOME/.nvm/versions/node/$NODE_DIR/bin/wrangler"
        fi
    fi

    if [ -z "$WRANGLER" ] || [ ! -x "$WRANGLER" ]; then
        echo "  âš  wrangler not found, skipping sync"
        return 0
    fi

    local ACCESS_TOKEN=$(jq -r '.claudeAiOauth.accessToken' "$CLAUDE_CREDS")
    local REFRESH_TOKEN=$(jq -r '.claudeAiOauth.refreshToken' "$CLAUDE_CREDS")
    local EXPIRES_AT=$(jq -r '.claudeAiOauth.expiresAt' "$CLAUDE_CREDS")

    (
        cd "$CLAUDE_WATCH_DIR/worker"
        echo "$ACCESS_TOKEN" | $WRANGLER secret put CLAUDE_ACCESS_TOKEN --quiet 2>/dev/null
        echo "$REFRESH_TOKEN" | $WRANGLER secret put CLAUDE_REFRESH_TOKEN --quiet 2>/dev/null
        echo "$EXPIRES_AT" | $WRANGLER secret put CLAUDE_TOKEN_EXPIRES_AT --quiet 2>/dev/null
        $WRANGLER kv key delete oauth_tokens --namespace-id=4b55acfc702f4698b53c5f1219edf63d --remote --force 2>/dev/null || true
    ) &>/dev/null

    echo "  âœ“ Credentials synced"
}

usage() {
    echo "Usage: claude-sandbox [path] [options] [prompt]"
    echo ""
    echo "Spawn Claude in isolated Docker sandbox with monitoring."
    echo ""
    echo "Options:"
    echo "  -c, --continue    Continue previous conversation"
    echo "  -h, --help        Show this help"
    echo ""
    echo "Examples:"
    echo "  claude-sandbox                    # Current dir, fresh session"
    echo "  claude-sandbox -c                 # Continue last conversation"
    echo "  claude-sandbox ~/projects/app     # Specific project"
    echo "  claude-sandbox . \"Fix the bug\"   # Start with a prompt"
    echo ""
    echo "Environment:"
    echo "  AGENT_ID is auto-generated for tracking."
    echo "  Metrics are sent to: $WORKER_URL"
}

# Parse args
WORKSPACE=""
CONTINUE=""
PROMPT=""

while [[ $# -gt 0 ]]; do
    case "$1" in
        -c|--continue)
            CONTINUE="-c"
            shift
            ;;
        -h|--help)
            usage
            exit 0
            ;;
        -*)
            echo "Unknown option: $1"
            usage
            exit 1
            ;;
        *)
            if [ -z "$WORKSPACE" ]; then
                # Check if it looks like a path
                if [ -d "$1" ] || [[ "$1" == /* ]] || [[ "$1" == .* ]] || [[ "$1" == ~* ]]; then
                    WORKSPACE="$1"
                else
                    # It's a prompt, use current dir
                    PROMPT="$1"
                fi
            else
                # Additional args become the prompt
                PROMPT="$1"
            fi
            shift
            ;;
    esac
done

# Default to current directory
WORKSPACE="${WORKSPACE:-$(pwd)}"
WORKSPACE=$(realpath "$WORKSPACE")
PROJECT=$(basename "$WORKSPACE")

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘  Claude Watch - Sandbox Mode               â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "Agent ID:  $AGENT_ID"
echo "Workspace: $WORKSPACE"
echo "Project:   $PROJECT"
echo ""

# Ensure tokens are fresh and synced
check_and_refresh_tokens

# Check if docker sandbox command is available
if ! docker sandbox --help >/dev/null 2>&1; then
    echo "ERROR: 'docker sandbox' command not found."
    echo "Requires Docker Desktop 4.50+ with sandbox feature enabled."
    exit 1
fi

# Ensure hooks are in the data volume
# This copies our hooks to the persistent volume that gets mounted at /mnt/claude-data
echo "Setting up hooks..."
docker run --rm -v "$CLAUDE_DATA_VOLUME:/mnt/claude-data" \
  -v "$CLAUDE_WATCH_DIR/hooks:/source:ro" \
  alpine sh -c "
    mkdir -p /mnt/claude-data/hooks
    cp /source/*.sh /mnt/claude-data/hooks/ 2>/dev/null || true
    chmod 755 /mnt/claude-data/hooks/*.sh 2>/dev/null || true
    chown -R 1000:1000 /mnt/claude-data/hooks 2>/dev/null || true
  "

# Write agent ID to file (env vars get overridden by sandbox)
docker run --rm -v "$CLAUDE_DATA_VOLUME:/mnt/claude-data" alpine sh -c "echo '$AGENT_ID' > /mnt/claude-data/agent-id"

# Write settings.json to /mnt/claude-data/settings.json
# The sandbox symlinks /home/agent/.claude/settings.json -> /mnt/claude-data/settings.json
docker run --rm -v "$CLAUDE_DATA_VOLUME:/mnt/claude-data" alpine sh -c 'cat > /mnt/claude-data/settings.json << "EOF"
{
  "statusLine": {
    "type": "command",
    "command": "/mnt/claude-data/hooks/statusline.sh"
  },
  "hooks": {
    "Stop": [
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "command",
            "command": "/mnt/claude-data/hooks/stop-hook.sh"
          }
        ]
      }
    ]
  }
}
EOF
'

echo "Starting Claude..."
echo ""

# Build docker sandbox args
SANDBOX_ARGS="-w $WORKSPACE"
SANDBOX_ARGS="$SANDBOX_ARGS -e AGENT_ID=$AGENT_ID"
SANDBOX_ARGS="$SANDBOX_ARGS -e PROJECT=$PROJECT"
SANDBOX_ARGS="$SANDBOX_ARGS -e WORKER_URL=$WORKER_URL"
SANDBOX_ARGS="$SANDBOX_ARGS -e CLAUDE_WATCH_DIR=/mnt/claude-data"

# Add Telegram env vars if set
[ -n "$TELEGRAM_BOT_TOKEN" ] && SANDBOX_ARGS="$SANDBOX_ARGS -e TELEGRAM_BOT_TOKEN=$TELEGRAM_BOT_TOKEN"
[ -n "$TELEGRAM_USER_ID" ] && SANDBOX_ARGS="$SANDBOX_ARGS -e TELEGRAM_CHAT_ID=$TELEGRAM_USER_ID"
[ -n "$TELEGRAM_CHAT_ID" ] && SANDBOX_ARGS="$SANDBOX_ARGS -e TELEGRAM_CHAT_ID=$TELEGRAM_CHAT_ID"

# Run docker sandbox
if [ -n "$PROMPT" ]; then
    docker sandbox run $SANDBOX_ARGS claude $CONTINUE "$PROMPT"
else
    docker sandbox run $SANDBOX_ARGS claude $CONTINUE
fi
