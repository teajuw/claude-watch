#!/bin/bash
# sync-credentials - Push local Claude credentials to Cloudflare Worker
# Run this when you see "OAuth token has expired" errors in the dashboard

set -e

CLAUDE_CREDS="$HOME/.claude/.credentials.json"
WORKER_DIR="$HOME/projects/claude-watch/worker"

# Check if credentials file exists
if [ ! -f "$CLAUDE_CREDS" ]; then
    echo "ERROR: Claude credentials not found at $CLAUDE_CREDS"
    echo "Run 'claude' and login first."
    exit 1
fi

# Extract tokens
ACCESS_TOKEN=$(jq -r '.claudeAiOauth.accessToken' "$CLAUDE_CREDS")
REFRESH_TOKEN=$(jq -r '.claudeAiOauth.refreshToken' "$CLAUDE_CREDS")
EXPIRES_AT=$(jq -r '.claudeAiOauth.expiresAt' "$CLAUDE_CREDS")

if [ -z "$ACCESS_TOKEN" ] || [ "$ACCESS_TOKEN" = "null" ]; then
    echo "ERROR: No access token found in credentials file."
    exit 1
fi

echo "╔════════════════════════════════════════════╗"
echo "║  Claude Watch - Credential Sync            ║"
echo "╚════════════════════════════════════════════╝"
echo ""
echo "Source: $CLAUDE_CREDS"
echo "Expires: $(date -d @$((EXPIRES_AT / 1000)) 2>/dev/null || echo "$(($EXPIRES_AT / 1000))")"
echo ""

# Find wrangler
if command -v wrangler &> /dev/null; then
    WRANGLER="wrangler"
elif [ -d "$HOME/.nvm" ]; then
    NODE_DIR=$(ls "$HOME/.nvm/versions/node/" 2>/dev/null | head -1)
    if [ -n "$NODE_DIR" ]; then
        WRANGLER="$HOME/.nvm/versions/node/$NODE_DIR/bin/wrangler"
    fi
fi

if [ -z "$WRANGLER" ] || [ ! -x "$WRANGLER" ]; then
    echo "ERROR: wrangler not found. Install it with: npm install -g wrangler"
    exit 1
fi

cd "$WORKER_DIR"

echo "Updating worker secrets..."
echo "$ACCESS_TOKEN" | $WRANGLER secret put CLAUDE_ACCESS_TOKEN --quiet
echo "  ✓ CLAUDE_ACCESS_TOKEN"

echo "$REFRESH_TOKEN" | $WRANGLER secret put CLAUDE_REFRESH_TOKEN --quiet
echo "  ✓ CLAUDE_REFRESH_TOKEN"

echo "$EXPIRES_AT" | $WRANGLER secret put CLAUDE_TOKEN_EXPIRES_AT --quiet
echo "  ✓ CLAUDE_TOKEN_EXPIRES_AT"

# Clear KV cache
echo ""
echo "Clearing token cache..."
$WRANGLER kv key delete oauth_tokens --namespace-id=4b55acfc702f4698b53c5f1219edf63d --remote --force 2>/dev/null || true
echo "  ✓ KV cache cleared"

echo ""
echo "Done! Dashboard should work now."
echo "Test: curl https://claude-watch.trevorju32.workers.dev/api/usage"
