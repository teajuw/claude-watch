#!/bin/bash
# sync-credentials - Push local Claude credentials to Cloudflare Worker
# Run this when you see "OAuth token has expired" errors in the dashboard
#
# Methods (in order of preference):
# 1. HTTP API with API_SECRET (no wrangler needed)
# 2. Wrangler secrets (requires wrangler CLI)

set -e

CLAUDE_CREDS="$HOME/.claude/.credentials.json"
WORKER_DIR="$HOME/projects/claude-watch/worker"
WORKER_URL="https://claude-watch.trevorju32.workers.dev"
CLAUDE_WATCH_DIR="${CLAUDE_WATCH_DIR:-$HOME/projects/claude-watch}"

# Load .env for API_SECRET
[ -f "$CLAUDE_WATCH_DIR/.env" ] && source "$CLAUDE_WATCH_DIR/.env"

# Check if credentials file exists
if [ ! -f "$CLAUDE_CREDS" ]; then
    echo "ERROR: Claude credentials not found at $CLAUDE_CREDS"
    echo "Run 'claude' and login first."
    exit 1
fi

# Extract tokens
ACCESS_TOKEN=$(jq -r '.claudeAiOauth.accessToken' "$CLAUDE_CREDS")
REFRESH_TOKEN=$(jq -r '.claudeAiOauth.refreshToken' "$CLAUDE_CREDS")
EXPIRES_AT=$(jq -r '.claudeAiOauth.expiresAt' "$CLAUDE_CREDS")

if [ -z "$ACCESS_TOKEN" ] || [ "$ACCESS_TOKEN" = "null" ]; then
    echo "ERROR: No access token found in credentials file."
    exit 1
fi

echo "╔════════════════════════════════════════════╗"
echo "║  Claude Watch - Credential Sync            ║"
echo "╚════════════════════════════════════════════╝"
echo ""
echo "Source: $CLAUDE_CREDS"
echo "Expires: $(date -d @$((EXPIRES_AT / 1000)) 2>/dev/null || echo "$(($EXPIRES_AT / 1000))")"
echo ""

# Method 1: Try HTTP API (preferred - no wrangler needed)
if [ -n "$API_SECRET" ]; then
    echo "Using HTTP API method..."
    RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "$WORKER_URL/api/tokens/update" \
        -H "Content-Type: application/json" \
        -H "Authorization: Bearer $API_SECRET" \
        -d "{
            \"accessToken\": \"$ACCESS_TOKEN\",
            \"refreshToken\": \"$REFRESH_TOKEN\",
            \"expiresAt\": $EXPIRES_AT
        }")

    HTTP_CODE=$(echo "$RESPONSE" | tail -1)
    BODY=$(echo "$RESPONSE" | sed '$d')

    if [ "$HTTP_CODE" = "200" ]; then
        echo "  ✓ Tokens synced via API"
        echo ""
        echo "Done! Dashboard should work now."
        echo "Test: curl $WORKER_URL/api/usage"
        exit 0
    else
        echo "  ⚠ API sync failed (HTTP $HTTP_CODE): $BODY"
        echo "  Falling back to wrangler..."
        echo ""
    fi
fi

# Method 2: Fall back to wrangler
if command -v wrangler &> /dev/null; then
    WRANGLER="wrangler"
elif [ -d "$HOME/.nvm" ]; then
    NODE_DIR=$(ls "$HOME/.nvm/versions/node/" 2>/dev/null | sort -V | tail -1)
    if [ -n "$NODE_DIR" ] && [ -x "$HOME/.nvm/versions/node/$NODE_DIR/bin/wrangler" ]; then
        WRANGLER="$HOME/.nvm/versions/node/$NODE_DIR/bin/wrangler"
    fi
fi

if [ -z "$WRANGLER" ]; then
    echo "ERROR: Neither API_SECRET nor wrangler available."
    echo ""
    echo "Options:"
    echo "  1. Add API_SECRET to $CLAUDE_WATCH_DIR/.env"
    echo "  2. Install wrangler: npm install -g wrangler"
    exit 1
fi

cd "$WORKER_DIR"

echo "Using wrangler method..."
echo "$ACCESS_TOKEN" | $WRANGLER secret put CLAUDE_ACCESS_TOKEN --quiet
echo "  ✓ CLAUDE_ACCESS_TOKEN"

echo "$REFRESH_TOKEN" | $WRANGLER secret put CLAUDE_REFRESH_TOKEN --quiet
echo "  ✓ CLAUDE_REFRESH_TOKEN"

echo "$EXPIRES_AT" | $WRANGLER secret put CLAUDE_TOKEN_EXPIRES_AT --quiet
echo "  ✓ CLAUDE_TOKEN_EXPIRES_AT"

# Clear KV cache
echo ""
echo "Clearing token cache..."
$WRANGLER kv key delete oauth_tokens --namespace-id=4b55acfc702f4698b53c5f1219edf63d --remote --force 2>/dev/null || true
echo "  ✓ KV cache cleared"

echo ""
echo "Done! Dashboard should work now."
echo "Test: curl $WORKER_URL/api/usage"
